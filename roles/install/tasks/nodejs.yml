---
- name: check nvm installed
  shell: "nvm --version >/dev/null 2>&1 && echo 0 || echo 1"
  register: installed_of_nvm
  changed_when: False
  tags:
    - nodejs

- name: check npm installed
  shell: "npm --version >/dev/null 2>&1 && echo 0 || echo 1"
  register: installed_of_npm
  changed_when: False
  tags:
    - nodejs

- name: check n installed
  shell: "n --version >/dev/null 2>&1 && echo 0 || echo 1"
  register: installed_of_n
  changed_when: False
  tags:
    - nodejs

- name: check node installed
  shell: "node -v >/dev/null 2>&1 && echo 0 || echo 1"
  register: installed_of_node
  changed_when: False
  tags:
    - nodejs

- name: install nodejs
  block:
    - name: create nvm dir
      file:
        dest: "{{ HOME_ROOT }}/.nvm"
        state: directory
        mode: 0755
      when: installed_of_nvm.stdout == "1"
      tags:
        - nodejs

    - name: install nvm
      shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v{{ NVM_VERSION }}/install.sh | bash
      when: installed_of_nvm.stdout == "1"
      tags:
        - nodejs

    - name: install nodejs
      shell: ". {{ HOME_ROOT }}/.bash_profile && nvm install {{ NODE_VERSION }}"
      when: installed_of_node.stdout == "1"
      tags:
        - nodejs

    - name: install n
      shell: ". {{ HOME_ROOT }}/.bash_profile && npm install -g n yarn pnpm --registry=https://registry.npm.taobao.org"
      when: installed_of_n.stdout == "1"
      tags:
        - nodejs

    - name: change directory mode
      shell: "chown -R $(whoami) /usr/local/bin /usr/local/lib /usr/local/include /usr/local/share"
      when: installed_of_node.stdout == "1"
      tags:
        - nodejs
      become: true
      become_method: sudo

    - name: install node
      shell: ". {{ HOME_ROOT }}/.bash_profile && n {{ NODE_VERSION }}"
      when: installed_of_node.stdout == "1"
      tags:
        - nodejs
      become: true
      become_method: sudo
  tags:
    - nodejs
