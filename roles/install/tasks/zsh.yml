---
- name: install zsh on Redhat
  yum:
    name: "{{item}}"
    state: present
    update_cache: true
  with_items:
    - zsh
  tags:
    - zsh
  when: ansible_os_family == "RedHat"

- name: install zsh on Ubuntu
  apt:
    pkg: "{{item}}"
    state: present
    update_cache: true
  with_items:
    - zsh
  tags:
    - zsh
  when: ansible_os_family == "Debian"

- name: install zsh on macOS
  shell: 'if [ $(brew list | grep {{item}} | wc -l) == "0" ]; then brew install {{item}}; else echo {{item}} is installed; fi'
  with_items:
    - zsh
    - zsh-syntax-highlighting
  tags:
    - zsh
  when: ansible_os_family == "Darwin"

- name: install oh-my-zsh
  block:
    - name: clean oh-my-zsh
      file:
        path: "{{HOME_ROOT}}/.oh-my-zsh/"
        state: absent

    - name: download oh-my-zsh
      shell:
        cmd: |
          sh -c "$(wget https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)" <<EOF
          exit
          EOF

    - name: download zsh autosuggestions
      git:
        repo: git://github.com/zsh-users/zsh-autosuggestions
        dest: "{{HOME_ROOT}}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        accept_hostkey: true
  tags:
    - zsh

- name: change terminal
  shell: chsh -s /bin/zsh
  become: yes
  become_method: sudo
  tags:
    - zsh

- name: copy zshrc template into home
  template:
    src: .zshrc
    dest: "{{HOME_ROOT}}"
    mode: 0644
    force: true
  tags:
    - zsh

- name: configuare zsh on Linux
  shell: "sed -i '3,6d' {{HOME_ROOT}}/.bash_profile"
  tags:
    - zsh
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

# mac的sed用法有区别
- name: configuare zsh on macOS
  shell: "sed -i \"\" '3,6d' {{HOME_ROOT}}/.bash_profile"
  tags:
    - zsh
  when: ansible_os_family == "Darwin"
