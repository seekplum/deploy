version: "3"
services:
  ldap:
    image: osixia/openldap:1.3.0
    environment:
      LDAP_ORGANISATION: "seekplum.io"
      LDAP_DOMAIN: "seekplum.io"
      LDAP_ADMIN_PASSWORD: "seekplum"
      LDAP_CONFIG_PASSWORD: "seekplum"
      LDAP_BACKEND: "mdb"
      LDAP_TLS: "false"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "guest"
      LDAP_READONLY_USER_PASSWORD: "123456"
      LDAP_SERVER_IP: ldap
    volumes:
      - ${VOLUMES_ROOT}/slapd/database:/var/lib/ldap
      - ${VOLUMES_ROOT}/slapd/config:/etc/ldap/slapd.d
      - ./bin/ldap.sh:/tmp/ldap.sh
      - ./conf/ldap/users.ldif:/tmp/users.ldif
    restart: on-failure
    command:
      - --copy-service
      - --loglevel=debug
  ldapadmin:
    image: osixia/phpldapadmin:0.9.0
    depends_on:
      - ldap
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
      PHPLDAPADMIN_HTTPS: "false"
    restart: on-failure
  gerrit:
    image: openfrontier/gerrit:3.0.0
    depends_on:
      - ldap
    volumes:
      - ${VOLUMES_ROOT}/gerrit:/var/gerrit/review_site
    environment:
      WEBURL: http://gerrit.seekplum.com
      GITWEB_TYPE: gitiles
      AUTH_TYPE: LDAP
      LDAP_SERVER: ldap://ldap
      LDAP_ACCOUNTBASE: dc=seekplum,dc=io
      LDAP_ACCOUNTPATTERN: (cn=$${username})
      LDAP_ACCOUNTSSHUSERNAME: $${cn}
      LDAP_ACCOUNTFULLNAME: $${sn}
      LDAP_USERNAME: cn=guest,dc=seekplum,dc=io
      LDAP_PASSWORD: 123456
      GERRIT_INIT_ARGS: --install-plugin=download-commands
    restart: on-failure
    healthcheck:
      test: "if [ `curl -I -m 10 -o /dev/null -s -w %{http_code} http://gerrit:8080` -ne 200 ]; then exit 1; else exit 0; fi;"
      interval: 5s
      timeout: 1s
      retries: 14
  gitea2:
    image: gitea/gitea:1.10.2
    depends_on:
      - ldap
      - gitea
    restart: on-failure
    user: git
    command: ["/bin/sh", "/init-gitea.sh"]
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - TZ=Asia/Shanghai
    volumes:
      - ${VOLUMES_ROOT}/gitea:/data
      - ./bin/init-gitea.sh:/init-gitea.sh
  gitea:
    image: gitea/gitea:1.10.2
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - TZ=Asia/Shanghai
    restart: always
    volumes:
      - ${VOLUMES_ROOT}/gitea:/data
  drone-server:
    image: drone/drone:1.6.4
    depends_on:
      - gitea
    volumes:
      - ${VOLUMES_ROOT}/drone:/data
    external_links:
      - gitea:gitea.seekplum.com
    restart: always
    environment:
      - DRONE_GIT_ALWAYS_AUTH=false
      - DRONE_GITEA_SERVER=http://gitea.seekplum.com:3000 # 需要在浏览器中和容器中都能访问
      - DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}
      - DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_SERVER_HOST=drone.seekplum.com
      - DRONE_SERVER_PROTO=http
      - DRONE_TLS_AUTOCERT=false
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_AGENTS_ENABLED=true
      - DRONE_USER_CREATE=username:hjd,admin:true
  drone-agent:
    image: drone/agent:1.6.2
    depends_on:
      - drone-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always
    environment:
      - DRONE_RPC_SERVER=http://drone.seekplum.com
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_RUNNER_NAME=seekplum
  nginx:
    image: nginx:alpine
#    network_mode: host  # MacOSX不支持host模式
    ports:
      - 8080:80
    volumes:
      - ./conf/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./conf/nginx/inc.d:/etc/nginx/inc.d:ro
      - ./data/www:/var/www:ro
      - ${VOLUMES_ROOT}/nginx/logs:/var/log/nginx
    restart: always
